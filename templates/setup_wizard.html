{% extends "layout.html" %}

{% block title %}Setup Wizard Â· Financial Command Center AI{% endblock %}

{% block content %}
<div class="space-y-10">
    <!-- Header Section -->
    <div class="card border border-border/70 p-7 shadow-card">
        <div class="space-y-6">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">
                    <i data-lucide="sparkles" class="h-3.5 w-3.5"></i>
                    Setup Wizard
                </span>
                <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Secure integration wizard</h1>
                <p class="text-base text-muted-foreground sm:text-lg">Connect Stripe, Plaid, and Xero credentials with guided validation. Secrets stay encrypted on this device.</p>
            </div>

            <!-- Progress Bar -->
            <div class="space-y-3">
                <div class="relative h-2 w-full rounded-full bg-muted/60">
                    <div class="absolute inset-y-0 left-0 h-full rounded-full bg-primary transition-all duration-300" id="progressFill" style="width: 0%;"></div>
                </div>
                <div class="text-xs font-medium uppercase tracking-[0.32em] text-muted-foreground">
                    Step <span id="currentStepLabel">0</span> of 3
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Section -->
    <div class="card border border-border/70 p-6 space-y-6">
        <div class="space-y-3">
            <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">
                <i data-lucide="sparkles" class="h-3.5 w-3.5"></i>
                Welcome
            </span>
            <h2 class="text-2xl font-semibold text-foreground">Welcome to Financial Command Center</h2>
            <p class="text-sm leading-relaxed text-muted-foreground">We'll guide you through connecting each integration, testing the credentials, and storing everything using the encrypted configuration manager.</p>
        </div>

        <div class="grid gap-4 md:grid-cols-3">
            <div class="card border border-border/70 p-6">
                <div class="flex items-start gap-3">
                    <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                        <i data-lucide="credit-card" class="h-5 w-5"></i>
                    </span>
                    <div>
                        <h3 class="text-base font-semibold text-foreground">Stripe payments</h3>
                        <p class="mt-1 text-sm text-muted-foreground">Capture charges, manage customers, and monitor payouts directly from the Command Center.</p>
                    </div>
                </div>
            </div>
            <div class="card border border-border/70 p-6">
                <div class="flex items-start gap-3">
                    <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                        <i data-lucide="banknote" class="h-5 w-5"></i>
                    </span>
                    <div>
                        <h3 class="text-base font-semibold text-foreground">Plaid banking</h3>
                        <p class="mt-1 text-sm text-muted-foreground">Stream sandbox or live banking data to demo real balance insights and transactions.</p>
                    </div>
                </div>
            </div>
            <div class="card border border-border/70 p-6">
                <div class="flex items-start gap-3">
                    <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                        <i data-lucide="file-text" class="h-5 w-5"></i>
                    </span>
                    <div>
                        <h3 class="text-base font-semibold text-foreground">Xero accounting</h3>
                        <p class="mt-1 text-sm text-muted-foreground">Sync invoices, contacts, and organisation metadata for unified financial reporting.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between gap-3 border-t border-border/60 pt-6">
            <p class="text-sm text-muted-foreground">You can skip any integration and return later from the admin dashboard.</p>
            <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90" onclick="beginSetup()">
                Begin setup
                <i data-lucide="arrow-right" class="h-4 w-4"></i>
            </button>
        </div>
    </div>

    <!-- Setup Steps -->
    <div class="space-y-8" id="setupSteps" style="display: none;">
        <!-- Step 1: Stripe -->
        <section class="step active" id="step1">
            <div class="card border border-border/70 p-6 space-y-6">
                <div class="space-y-3">
                    <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">
                        Step 1 of 3
                    </span>
                    <h2 class="text-2xl font-semibold text-foreground">Connect Stripe</h2>
                    <p class="text-sm leading-relaxed text-muted-foreground">Use a restricted key wherever possible. The wizard encrypts values at rest and never transmits them externally.</p>
                </div>

                <div id="stripe-messages" class="space-y-3"></div>

                <div class="card border border-border/70 p-6" id="stripeCard">
                    <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                                <i data-lucide="credit-card" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <h3 class="text-base font-semibold text-foreground">Stripe API configuration</h3>
                                <p class="mt-1 text-sm text-muted-foreground">Validate connectivity before saving credentials.</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground" id="stripeStatus">Pending</span>
                    </div>

                    <form id="stripeForm" onsubmit="event.preventDefault();" class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-foreground" for="stripeApiKey">Stripe secret key</label>
                            <input type="password" id="stripeApiKey" name="stripe_api_key" placeholder="sk_live_... or sk_test_..." autocomplete="off" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
                            <p class="text-xs text-muted-foreground">Starts with sk_test_ for sandbox or sk_live_ for production.</p>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-foreground" for="stripePublishableKey">Publishable key (optional)</label>
                            <input type="text" id="stripePublishableKey" name="stripe_publishable_key" placeholder="pk_live_... or pk_test_..." autocomplete="off" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
                            <p class="text-xs text-muted-foreground">Required if you plan to demonstrate client-side payment flows.</p>
                        </div>
                        <div class="mt-6 flex flex-wrap items-center gap-3">
                            <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-border/70 bg-muted/60 px-4 py-2 text-sm font-medium text-foreground transition hover:border-primary/40 hover:text-primary" onclick="testStripeConnection()">
                                <span id="stripeTestSpinner" class="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground" style="display: none;">
                                    <div class="h-4 w-4 animate-spin rounded-full border-2 border-muted-foreground/40 border-t-primary"></div>
                                    Testing
                                </span>
                                <span id="stripeTestText">Test connection</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="flex flex-wrap items-center justify-between gap-3 border-t border-border/60 pt-6">
                    <div></div>
                    <div class="flex flex-wrap items-center gap-3">
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-transparent px-4 py-2 text-sm font-medium text-muted-foreground transition hover:text-foreground" onclick="skipStripe()">Skip for now</button>
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90" onclick="nextStep()" id="stripeNext" disabled>
                            Continue to Plaid
                            <i data-lucide="arrow-right" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2: Plaid -->
        <section class="step" id="step2" style="display: none;">
            <div class="card border border-border/70 p-6 space-y-6">
                <div class="space-y-3">
                    <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">
                        Step 2 of 3
                    </span>
                    <h2 class="text-2xl font-semibold text-foreground">Configure Plaid banking</h2>
                    <p class="text-sm leading-relaxed text-muted-foreground">Supply sandbox credentials to demonstrate flows instantly, or connect production once you're ready.</p>
                </div>

                <div id="plaid-messages" class="space-y-3"></div>

                <div class="card border border-border/70 p-6" id="plaidCard">
                    <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                                <i data-lucide="banknote" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <h3 class="text-base font-semibold text-foreground">Plaid API credentials</h3>
                                <p class="mt-1 text-sm text-muted-foreground">Supports sandbox, development, and production environments.</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground" id="plaidStatus">Pending</span>
                    </div>

                    <form id="plaidForm" onsubmit="event.preventDefault();" class="space-y-4">
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-foreground" for="plaidClientId">Plaid client ID</label>
                                <input type="text" id="plaidClientId" name="plaid_client_id" placeholder="client id" autocomplete="off" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
                                <p class="text-xs text-muted-foreground">Available in the Plaid dashboard.</p>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-foreground" for="plaidSecret">Plaid secret</label>
                                <input type="password" id="plaidSecret" name="plaid_secret" placeholder="secret key" autocomplete="off" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
                                <p class="text-xs text-muted-foreground">Use sandbox credentials for demos.</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-foreground" for="plaidEnvironment">Environment</label>
                            <select id="plaidEnvironment" name="plaid_environment" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20">
                                <option value="sandbox">Sandbox (testing)</option>
                                <option value="development">Development</option>
                                <option value="production">Production (live)</option>
                            </select>
                        </div>
                        <div class="mt-6 flex flex-wrap items-center gap-3">
                            <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-border/70 bg-muted/60 px-4 py-2 text-sm font-medium text-foreground transition hover:border-primary/40 hover:text-primary" onclick="testPlaidConnection()">
                                <span id="plaidTestSpinner" class="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground" style="display: none;">
                                    <div class="h-4 w-4 animate-spin rounded-full border-2 border-muted-foreground/40 border-t-primary"></div>
                                    Testing
                                </span>
                                <span id="plaidTestText">Test configuration</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="flex flex-wrap items-center justify-between gap-3 border-t border-border/60 pt-6">
                    <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-border/70 px-4 py-2 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80" onclick="prevStep()">
                        <i data-lucide="arrow-left" class="h-4 w-4"></i>
                        Back to Stripe
                    </button>
                    <div class="flex flex-wrap items-center gap-3">
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-transparent px-4 py-2 text-sm font-medium text-muted-foreground transition hover:text-foreground" onclick="skipPlaid()">Skip for now</button>
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90" onclick="nextStep()" id="plaidNext" disabled>
                            Continue to Xero
                            <i data-lucide="arrow-right" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 3: Xero -->
        <section class="step" id="step3" style="display: none;">
            <div class="card border border-border/70 p-6 space-y-6">
                <div class="space-y-3">
                    <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">
                        Step 3 of 3
                    </span>
                    <h2 class="text-2xl font-semibold text-foreground">Configure Xero OAuth</h2>
                    <p class="text-sm leading-relaxed text-muted-foreground">Create a confidential application in the Xero developer portal, then paste the client ID and secret here.</p>
                </div>

                <div id="xero-messages" class="space-y-3"></div>

                <div class="card border border-border/70 p-6" id="xeroCard">
                    <div class="flex flex-wrap items-start justify-between gap-3 mb-4">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                                <i data-lucide="file-text" class="h-5 w-5"></i>
                            </span>
                            <div>
                                <h3 class="text-base font-semibold text-foreground">Xero OAuth credentials</h3>
                                <p class="mt-1 text-sm text-muted-foreground">After validation, the wizard manages refresh tokens for you.</p>
                            </div>
                        </div>
                        <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground" id="xeroStatus">Pending</span>
                    </div>

                    <form id="xeroForm" onsubmit="event.preventDefault();" class="space-y-4">
                        <div class="grid gap-4 md:grid-cols-2">
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-foreground" for="xeroClientId">Xero client ID</label>
                                <input type="text" id="xeroClientId" name="xero_client_id" placeholder="client id" autocomplete="off" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-foreground" for="xeroClientSecret">Xero client secret</label>
                                <input type="password" id="xeroClientSecret" name="xero_client_secret" placeholder="client secret" autocomplete="off" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20" />
                            </div>
                        </div>
                        <div class="mt-6 flex flex-wrap items-center gap-3">
                            <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-border/70 bg-muted/60 px-4 py-2 text-sm font-medium text-foreground transition hover:border-primary/40 hover:text-primary" onclick="testXeroConnection()">
                                <span id="xeroTestSpinner" class="inline-flex items-center gap-2 text-sm font-medium text-muted-foreground" style="display: none;">
                                    <div class="h-4 w-4 animate-spin rounded-full border-2 border-muted-foreground/40 border-t-primary"></div>
                                    Testing
                                </span>
                                <span id="xeroTestText">Validate credentials</span>
                            </button>
                        </div>
                    </form>
                </div>

                <div class="flex flex-wrap items-center justify-between gap-3 border-t border-border/60 pt-6">
                    <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-border/70 px-4 py-2 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80" onclick="prevStep()">
                        <i data-lucide="arrow-left" class="h-4 w-4"></i>
                        Back to Plaid
                    </button>
                    <div class="flex flex-wrap items-center gap-3">
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-transparent px-4 py-2 text-sm font-medium text-muted-foreground transition hover:text-foreground" onclick="skipXero()">Skip for now</button>
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90" onclick="finishSetup()" id="xeroNext" disabled>
                            Finish setup
                            <i data-lucide="check" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Completion -->
        <section class="step" id="completion" style="display: none;">
            <div class="card border border-border/70 p-10 text-center space-y-6">
                <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-primary/15 text-3xl text-primary mx-auto">
                    <i data-lucide="sparkles" class="h-8 w-8"></i>
                </div>
                <div class="space-y-3">
                    <h2 class="text-2xl font-semibold text-foreground">Setup complete</h2>
                    <p class="max-w-xl mx-auto text-sm text-muted-foreground">All integrations have been saved securely. Launch the dashboard or health check to verify everything is operating as expected.</p>
                </div>
                <div class="flex flex-wrap items-center justify-center gap-3">
                    <a class="inline-flex items-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90" href="/admin/dashboard">
                        Dashboard
                        <i data-lucide="arrow-right" class="h-4 w-4"></i>
                    </a>
                    <a class="inline-flex items-center gap-2 rounded-lg border border-border/70 px-4 py-2 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80" href="/health">
                        System health
                    </a>
                    <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-transparent px-4 py-2 text-sm font-medium text-muted-foreground transition hover:text-foreground" onclick="location.reload()">Run wizard again</button>
                </div>
            </div>
        </section>
    </div>
</div>

<style>
.step {
    display: none;
}
.step.active {
    display: block;
}
</style>

<script>
let currentStep = 0; // 0 = welcome, 1 = Stripe, 2 = Plaid, 3 = Xero
const totalSteps = 3;
let stripeConfigured = false;
let plaidConfigured = false;
let xeroConfigured = false;

function updateProgress() {
    const progress = currentStep === 0 ? 0 : (currentStep / totalSteps) * 100;
    const fill = document.getElementById('progressFill');
    if (fill) {
        fill.style.width = progress + '%';
    }
    const label = document.getElementById('currentStepLabel');
    if (label) {
        label.textContent = currentStep;
    }
}

function beginSetup() {
    // Show the setup steps and scroll to them
    document.getElementById('setupSteps').style.display = 'block';
    currentStep = 1;
    showStep(1);
    // Smooth scroll to the setup steps
    setTimeout(() => {
        document.getElementById('setupSteps').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }, 100);
}

function scrollToStep(elementId) {
    const target = document.getElementById(elementId);
    if (!target) {
        return;
    }
    const offset = 80;
    const targetPosition = target.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top: Math.max(targetPosition, 0), behavior: 'smooth' });
}

function showStep(step) {
    document.querySelectorAll('.step').forEach((section) => section.classList.remove('active'));
    const target = document.getElementById('step' + step);
    if (target) {
        target.classList.add('active');
        target.style.display = 'block';
    }
    currentStep = step;
    updateProgress();
    if (window.lucide) {
        window.lucide.createIcons();
    }
}

function nextStep() {
    if (currentStep < totalSteps) {
        const upcomingStep = currentStep + 1;
        showStep(upcomingStep);
        requestAnimationFrame(() => scrollToStep('step' + upcomingStep));
    } else {
        // Show completion
        document.querySelectorAll('.step').forEach((section) => section.classList.remove('active'));
        document.getElementById('completion').classList.add('active');
        document.getElementById('completion').style.display = 'block';
        currentStep = totalSteps;
        updateProgress();
        requestAnimationFrame(() => scrollToStep('completion'));
    }
}

function prevStep() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function buildApiUrl(path) {
    try {
        const origin = window.location.origin || '';
        if (!origin || origin.startsWith('file:')) {
            return 'https://127.0.0.1:8000' + path;
        }
        return origin + path;
    } catch (e) {
        return 'https://127.0.0.1:8000' + path;
    }
}

function showMessage(containerId, type, message) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const wrapper = document.createElement('div');
    wrapper.className = type === 'error'
        ? 'rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700'
        : 'rounded-lg border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700';
    wrapper.setAttribute('role', 'alert');
    wrapper.innerHTML = `
        <div class="flex items-start gap-3">
            <i data-lucide="${type === 'error' ? 'alert-triangle' : 'check-circle'}" class="h-4 w-4 flex-shrink-0"></i>
            <div class="space-y-1 text-sm leading-relaxed">${message}</div>
        </div>
    `;
    container.innerHTML = '';
    container.appendChild(wrapper);
    if (window.lucide) {
        window.lucide.createIcons();
    }
}

async function testStripeConnection() {
    const apiKey = document.getElementById('stripeApiKey').value;
    if (!apiKey) {
        showMessage('stripe-messages', 'error', 'Enter your Stripe secret key before testing.');
        return;
    }

    const testSpinner = document.getElementById('stripeTestSpinner');
    const testText = document.getElementById('stripeTestText');
    const status = document.getElementById('stripeStatus');

    status.textContent = 'Testing...';
    status.className = 'inline-flex items-center gap-2 rounded-full border border-sky-200 bg-sky-100 text-sky-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';

    if (testSpinner && testText) {
        testSpinner.style.display = 'inline-flex';
        testText.style.display = 'none';
    }

    try {
        const response = await fetch(buildApiUrl('/api/setup/test-stripe'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stripe_api_key: apiKey,
                stripe_publishable_key: document.getElementById('stripePublishableKey').value
            })
        });

        const result = await response.json();

        if (result.success) {
            stripeConfigured = true;
            status.textContent = 'Connected';
            status.className = 'inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
            document.getElementById('stripeNext').disabled = false;
            showMessage('stripe-messages', 'success', `Connected to Stripe successfully. Account: ${result.account_name || 'unknown'}.`);
        } else {
            throw new Error(result.error || 'Connection failed');
        }
    } catch (error) {
        status.textContent = 'Error';
        status.className = 'inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
        document.getElementById('stripeNext').disabled = true;
        showMessage('stripe-messages', 'error', `Stripe connection failed: ${error.message}`);
    } finally {
        if (testSpinner && testText) {
            testSpinner.style.display = 'none';
            testText.style.display = 'inline';
        }
    }
}

function skipStripe() {
    stripeConfigured = false;
    const status = document.getElementById('stripeStatus');
    status.textContent = 'Skipped';
    status.className = 'inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
    document.getElementById('stripeNext').disabled = false;
    showMessage('stripe-messages', 'success', 'Stripe configuration skipped. You can enable it later from the admin dashboard.');
}

async function testPlaidConnection() {
    const clientId = document.getElementById('plaidClientId').value;
    const secret = document.getElementById('plaidSecret').value;
    const environment = document.getElementById('plaidEnvironment').value;

    if (!clientId || !secret) {
        showMessage('plaid-messages', 'error', 'Enter your Plaid client ID and secret before testing.');
        return;
    }

    const testSpinner = document.getElementById('plaidTestSpinner');
    const testText = document.getElementById('plaidTestText');
    const status = document.getElementById('plaidStatus');

    status.textContent = 'Testing...';
    status.className = 'inline-flex items-center gap-2 rounded-full border border-sky-200 bg-sky-100 text-sky-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';

    if (testSpinner && testText) {
        testSpinner.style.display = 'inline-flex';
        testText.style.display = 'none';
    }

    try {
        const response = await fetch(buildApiUrl('/api/setup/test-plaid'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                plaid_client_id: clientId,
                plaid_secret: secret,
                plaid_environment: environment
            })
        });

        const result = await response.json();

        if (result.success) {
            plaidConfigured = true;
            status.textContent = 'Configured';
            status.className = 'inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
            document.getElementById('plaidNext').disabled = false;
            showMessage('plaid-messages', 'success', `Plaid credentials verified. Environment: ${result.environment || environment}.`);
        } else {
            throw new Error(result.error || 'Verification failed');
        }
    } catch (error) {
        plaidConfigured = false;
        status.textContent = 'Error';
        status.className = 'inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
        document.getElementById('plaidNext').disabled = true;
        showMessage('plaid-messages', 'error', `Plaid verification failed: ${error.message}`);
    } finally {
        if (testSpinner && testText) {
            testSpinner.style.display = 'none';
            testText.style.display = 'inline';
        }
    }
}

function skipPlaid() {
    plaidConfigured = false;
    const status = document.getElementById('plaidStatus');
    status.textContent = 'Skipped';
    status.className = 'inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
    document.getElementById('plaidNext').disabled = false;
    showMessage('plaid-messages', 'success', 'Plaid integration skipped. Banking workflows remain available in demo mode.');
}

async function testXeroConnection() {
    const clientId = document.getElementById('xeroClientId').value;
    const clientSecret = document.getElementById('xeroClientSecret').value;

    if (!clientId || !clientSecret) {
        showMessage('xero-messages', 'error', 'Enter both the Xero client ID and secret.');
        return;
    }

    const testSpinner = document.getElementById('xeroTestSpinner');
    const testText = document.getElementById('xeroTestText');
    const status = document.getElementById('xeroStatus');

    status.textContent = 'Testing...';
    status.className = 'inline-flex items-center gap-2 rounded-full border border-sky-200 bg-sky-100 text-sky-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';

    if (testSpinner && testText) {
        testSpinner.style.display = 'inline-flex';
        testText.style.display = 'none';
    }

    try {
        const response = await fetch(buildApiUrl('/api/setup/test-xero'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                xero_client_id: clientId,
                xero_client_secret: clientSecret
            })
        });

        const result = await response.json();

        if (result.success) {
            xeroConfigured = true;
            status.textContent = 'Connected';
            status.className = 'inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
            document.getElementById('xeroNext').disabled = false;
            showMessage('xero-messages', 'success', 'Xero credentials validated successfully.');
        } else {
            throw new Error(result.error || 'Validation failed');
        }
    } catch (error) {
        status.textContent = 'Error';
        status.className = 'inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
        document.getElementById('xeroNext').disabled = true;
        showMessage('xero-messages', 'error', `Xero validation failed: ${error.message}`);
    } finally {
        if (testSpinner && testText) {
            testSpinner.style.display = 'none';
            testText.style.display = 'inline';
        }
    }
}

function skipXero() {
    xeroConfigured = false;
    const status = document.getElementById('xeroStatus');
    status.textContent = 'Skipped';
    status.className = 'inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em]';
    document.getElementById('xeroNext').disabled = false;
    showMessage('xero-messages', 'success', 'Xero integration skipped. Demo mode will stay active until credentials are added.');
}

async function finishSetup() {
    try {
        const configData = {
            stripe: stripeConfigured ? {
                api_key: document.getElementById('stripeApiKey').value,
                publishable_key: document.getElementById('stripePublishableKey').value
            } : { skipped: true },
            plaid: plaidConfigured ? {
                client_id: document.getElementById('plaidClientId').value,
                secret: document.getElementById('plaidSecret').value,
                environment: document.getElementById('plaidEnvironment').value
            } : { skipped: true },
            xero: xeroConfigured ? {
                client_id: document.getElementById('xeroClientId').value,
                client_secret: document.getElementById('xeroClientSecret').value
            } : { skipped: true }
        };

        const response = await fetch(buildApiUrl('/api/setup/save-config'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configData)
        });

        const result = await response.json();

        if (result.success) {
            nextStep(); // This will show the completion screen
        } else {
            throw new Error(result.error || 'Configuration save failed');
        }
    } catch (error) {
        showMessage('xero-messages', 'error', `Save failed: ${error.message}`);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    updateProgress();
    if (window.lucide) {
        window.lucide.createIcons();
    }
});
</script>
{% endblock %}