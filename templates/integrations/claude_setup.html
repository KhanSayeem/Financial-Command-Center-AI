{% extends "layout.html" %}

{% block title %}Claude Desktop Integration · Financial Command Center AI{% endblock %}

{% block content %}
<div class="space-y-10">
    <div class="card border border-border/70 p-7 shadow-card">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-3 py-1 text-xs font-medium uppercase tracking-[0.28em] text-primary">
                    <i data-lucide="bot" class="h-3.5 w-3.5"></i>
                    Claude Desktop
                </span>
                <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Connect Claude to your financial cockpit</h1>
                <p class="text-sm text-muted-foreground">Guide Claude through a trusted HTTPS endpoint so natural-language commands can orchestrate workflows across Stripe, Plaid, and Xero.</p>
            </div>
            <a href="/admin/dashboard" class="inline-flex items-center gap-2 rounded-lg border border-border/70 bg-card px-4 py-2 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80">
                <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                Back to admin
            </a>
        </div>
    </div>

    <section class="card border border-border/70 p-6 space-y-4">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="space-y-1">
                <h2 class="text-lg font-semibold text-foreground">Generate configuration</h2>
                <p class="text-sm text-muted-foreground">Build a Claude Desktop config tailored to your workspace and credentials.</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <button type="button" id="claude-generate-btn" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                    <i data-lucide="sparkles" class="h-4 w-4"></i>
                    <span>Generate config</span>
                </button>
                <button type="button" id="claude-download-btn" class="hidden inline-flex items-center gap-2 rounded-lg border border-border/70 bg-background px-4 py-2 text-sm font-medium text-foreground shadow-sm transition hover:bg-background/80">
                    <i data-lucide="download" class="h-4 w-4"></i>
                    <span>Download JSON</span>
                </button>
            </div>
        </div>
        <div id="claude-config-summary" data-base-class="rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground" class="hidden rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground"></div>
    </section>

    <div class="grid gap-6 lg:grid-cols-2">
        <section class="card border border-border/70 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-foreground">Prerequisites</h2>
            <ul class="space-y-3 text-sm text-muted-foreground">
                <li class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4 text-emerald-600"></i> Claude Desktop installed (latest version).</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4 text-emerald-600"></i> Financial Command Center running over HTTPS (see SSL help in admin).</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4 text-emerald-600"></i> Demo API key generated from the admin dashboard.</li>
            </ul>
        </section>

        <section class="card border border-border/70 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-foreground">Connection details</h2>
            <dl class="grid gap-3 text-sm">
                <div>
                    <dt class="text-muted-foreground">Local endpoint</dt>
                    <dd class="font-medium text-foreground">{{ server_url }}</dd>
                </div>
                <div>
                    <dt class="text-muted-foreground">API key header</dt>
                    <dd class="font-medium text-foreground">X-API-Key</dd>
                </div>
                <div>
                    <dt class="text-muted-foreground">Recommended scope</dt>
                    <dd class="font-medium text-foreground">read, write</dd>
                </div>
            </dl>
        </section>
    </div>

    <section class="card border border-border/70 p-6 space-y-4">
        <h2 class="text-lg font-semibold text-foreground">Setup steps</h2>
        <ol class="space-y-4 text-sm text-muted-foreground">
            <li>
                <span class="font-medium text-foreground">1. Add a new tool in Claude Desktop</span>
                <p>Open Claude preferences → Tools → “Add custom tool” and provide the HTTPS endpoint above.</p>
            </li>
            <li>
                <span class="font-medium text-foreground">2. Provide authentication</span>
                <p>Use the generated API key and set header <code>X-API-Key</code>. Claude will include this header in every request.</p>
            </li>
            <li>
                <span class="font-medium text-foreground">3. Test with a natural-language command</span>
                <p>Try <code>Show the latest five invoices and mark any overdue ones</code>. Claude will call the Command Center endpoints.</p>
            </li>
        </ol>
    </section>

    <section class="card border border-border/70 p-6 space-y-4">
        <h2 class="text-lg font-semibold text-foreground">Example prompts</h2>
        <div class="grid gap-3 md:grid-cols-2">
            <div class="rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground">
                “Summarize Stripe payments above $1,000 this week.”
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground">
                “List Xero contacts flagged as suppliers with outstanding balances.”
            </div>
        </div>
    </section>
</div>
{% endblock %}


{% block body_scripts %}
    {{ super() }}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const generateBtn = document.getElementById('claude-generate-btn');
        const downloadBtn = document.getElementById('claude-download-btn');
        const summaryEl = document.getElementById('claude-config-summary');
        const summaryBase = summaryEl ? summaryEl.dataset.baseClass || '' : '';
        let configData = null;

        const formatLabel = (value) => value
          ? value.replace(/_/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase())
          : '';

        function setLoading(isLoading) {
          if (!generateBtn) return;
          const label = generateBtn.querySelector('span');
          generateBtn.disabled = isLoading;
          generateBtn.classList.toggle('opacity-70', isLoading);
          generateBtn.classList.toggle('cursor-not-allowed', isLoading);
          generateBtn.setAttribute('aria-busy', String(isLoading));
          if (label) {
            if (isLoading) {
              generateBtn.dataset.originalLabel = label.textContent.trim();
              label.textContent = 'Generating…';
            } else if (generateBtn.dataset.originalLabel) {
              label.textContent = generateBtn.dataset.originalLabel;
              delete generateBtn.dataset.originalLabel;
            }
          }
        }

        function showMessage(html, tone = 'info') {
          if (!summaryEl) return;
          const toneClasses = {
            success: 'border-emerald-200 bg-emerald-50 text-emerald-700',
            error: 'border-rose-200 bg-rose-50 text-rose-700',
            info: 'border-border/60 bg-muted/60 text-muted-foreground',
          };
          summaryEl.className = `${summaryBase} ${toneClasses[tone] || toneClasses.info}`.trim();
          summaryEl.innerHTML = html;
          summaryEl.classList.remove('hidden');
        }

        generateBtn?.addEventListener('click', async () => {
          setLoading(true);
          showMessage('<p class="font-medium">Generating configuration…</p>', 'info');
          try {
            const response = await fetch('/api/claude/generate-config');
            const data = await response.json();
            if (!response.ok || !data.success) {
              throw new Error(data.message || 'Failed to generate configuration');
            }
            configData = data.config;
            const servers = (data.summary?.servers || []).map((name) => `<code>${name}</code>`).join(', ');
            const credentials = data.summary?.credentials_used || {};
            const credentialSummary = Object.entries(credentials)
              .filter(([, used]) => used)
              .map(([key]) => formatLabel(key))
              .join(', ') || 'Demo credentials';
            const pythonInfo = data.summary?.python_executable || 'python';
            const content = `
              <div class="space-y-2">
                <p class="font-medium text-foreground">Configuration generated successfully.</p>
                <ul class="space-y-1">
                  <li>Servers included: ${servers || 'None'}</li>
                  <li>Credentials used: ${credentialSummary}</li>
                  <li>Python executable: <code>${pythonInfo}</code></li>
                </ul>
              </div>
            `;
            showMessage(content, 'success');
            if (downloadBtn) {
              downloadBtn.classList.remove('hidden');
              downloadBtn.focus();
            }
          } catch (error) {
            showMessage(`
              <div class="space-y-1">
                <p class="font-medium">Could not generate configuration.</p>
                <p>${error.message}</p>
              </div>
            `, 'error');
          } finally {
            setLoading(false);
          }
        });

        downloadBtn?.addEventListener('click', () => {
          if (!configData) {
            showMessage('<p>Please generate a configuration before downloading.</p>', 'error');
            return;
          }
          const blob = new Blob([configData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement('a');
          anchor.href = url;
          anchor.download = 'claude_desktop_config.json';
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
          URL.revokeObjectURL(url);
        });
      });
    </script>
{% endblock %}
