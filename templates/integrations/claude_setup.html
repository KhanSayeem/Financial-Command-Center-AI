{% extends "layout.html" %}

{% block title %}Claude Desktop Integration · Financial Command Center AI{% endblock %}

{% block content %}
<div class="space-y-10">
    <div class="card border border-border/70 p-7 shadow-card">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-3 py-1 text-xs font-medium uppercase tracking-[0.28em] text-primary">
                    <i data-lucide="bot" class="h-3.5 w-3.5"></i>
                    Claude Desktop
                </span>
                <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Connect Claude to your financial cockpit</h1>
                <p class="text-sm text-muted-foreground">Guide Claude through a trusted HTTPS endpoint so natural-language commands can orchestrate workflows across Stripe, Plaid, and Xero.</p>
            </div>
            <a href="/admin/dashboard" class="inline-flex items-center gap-2 rounded-lg border border-border/70 bg-card px-4 py-2 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80">
                <i data-lucide="layout-dashboard" class="h-4 w-4"></i>
                Back to admin
            </a>
        </div>
    </div>

    <section class="card border border-border/70 p-6 space-y-4">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div class="space-y-1">
                <h2 class="text-lg font-semibold text-foreground">Generate configuration</h2>
                <p class="text-sm text-muted-foreground">Build a Claude Desktop config tailored to your workspace and credentials.</p>
                <p class="text-xs text-muted-foreground">Want a zero-copy experience? Use the connect button to write the config straight into Claude&rsquo;s folder—FCC makes a backup first.</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <button type="button" id="claude-generate-btn" class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                    <i data-lucide="sparkles" class="h-4 w-4"></i>
                    <span>Generate config</span>
                </button>
                <button type="button" id="claude-connect-btn" class="inline-flex items-center gap-2 rounded-lg border border-border/70 bg-card px-4 py-2 text-sm font-medium text-foreground shadow-sm transition hover:border-border hover:bg-card/80">
                    <i data-lucide="plug" class="h-4 w-4"></i>
                    <span>Connect automatically</span>
                </button>
                <button type="button" id="claude-download-btn" class="hidden inline-flex items-center gap-2 rounded-lg border border-border/70 bg-background px-4 py-2 text-sm font-medium text-foreground shadow-sm transition hover:bg-background/80">
                    <i data-lucide="download" class="h-4 w-4"></i>
                    <span>Download JSON</span>
                </button>
            </div>
        </div>
        <div id="claude-config-summary" data-base-class="rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground" class="hidden rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground"></div>
    </section>

    <div class="grid gap-6 lg:grid-cols-2">
        <section class="card border border-border/70 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-foreground">Prerequisites</h2>
            <ul class="space-y-3 text-sm text-muted-foreground">
                <li class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4 text-emerald-600"></i> Claude Desktop installed (latest version).</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4 text-emerald-600"></i> Financial Command Center running over HTTPS (see SSL help in admin).</li>
                <li class="flex items-center gap-2"><i data-lucide="check" class="h-4 w-4 text-emerald-600"></i> Demo API key generated from the admin dashboard.</li>
            </ul>
        </section>

        <section class="card border border-border/70 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-foreground">Connection details</h2>
            <dl class="grid gap-3 text-sm">
                <div>
                    <dt class="text-muted-foreground">Local endpoint</dt>
                    <dd class="font-medium text-foreground">{{ server_url }}</dd>
                </div>
                <div>
                    <dt class="text-muted-foreground">API key header</dt>
                    <dd class="font-medium text-foreground">X-API-Key</dd>
                </div>
                <div>
                    <dt class="text-muted-foreground">Recommended scope</dt>
                    <dd class="font-medium text-foreground">read, write</dd>
                </div>
            </dl>
        </section>
    </div>

    <section class="card border border-border/70 p-6 space-y-3">
        <h2 class="text-lg font-semibold text-foreground">Live sync APIs</h2>
        <p class="text-sm text-muted-foreground">Whenever Stripe, Xero, or Plaid are connected via the setup wizard, FCC exposes read-only aggregation routes. Claude Desktop can call these directly (or through the MCP servers) to hydrate the latest financial context.</p>
        <ul class="space-y-2 text-sm text-muted-foreground">
            <li><code>GET /sync/stripe</code> — returns recent payments, refunds, and the Stripe balance.</li>
            <li><code>GET /sync/xero</code> — returns invoices, contacts, and chart-of-account data for the selected tenant.</li>
            <li><code>GET /sync/plaid</code> — returns linked bank balances and the latest 30 days of transactions.</li>
        </ul>
        <p class="text-xs text-muted-foreground">These endpoints respond only when the corresponding integration is marked as “Connected”. Re-run the setup wizard if Claude reports that an integration is pending.</p>
    </section>

    <section class="card border border-border/70 p-6 space-y-4">
        <h2 class="text-lg font-semibold text-foreground">Setup steps</h2>
        <ol class="space-y-4 text-sm text-muted-foreground">
            <li>
                <span class="font-medium text-foreground">1. Add a new tool in Claude Desktop</span>
                <p>Open Claude preferences → Tools → “Add custom tool” and provide the HTTPS endpoint above.</p>
            </li>
            <li>
                <span class="font-medium text-foreground">2. Provide authentication</span>
                <p>Use the generated API key and set header <code>X-API-Key</code>. Claude will include this header in every request.</p>
            </li>
            <li>
                <span class="font-medium text-foreground">3. Test with a natural-language command</span>
                <p>Try <code>Show the latest five invoices and mark any overdue ones</code>. Claude will call the Command Center endpoints.</p>
            </li>
        </ol>
    </section>

    <section class="card border border-border/70 p-6 space-y-4">
        <h2 class="text-lg font-semibold text-foreground">Example prompts</h2>
        <div class="grid gap-3 md:grid-cols-2">
            <div class="rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground">
                “Summarize Stripe payments above $1,000 this week.”
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 px-4 py-3 text-sm text-muted-foreground">
                “List Xero contacts flagged as suppliers with outstanding balances.”
            </div>
        </div>
    </section>

    <div id="claude-connect-modal" class="fixed inset-0 z-40 hidden overflow-y-auto bg-background/80 px-4 py-6 backdrop-blur-md">
        <div class="flex min-h-full items-center justify-center">
        <div class="mx-auto w-full max-w-2xl rounded-2xl border border-border/70 bg-card shadow-2xl">
            <div class="flex items-start justify-between border-b border-border/60 px-6 py-4">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">Auto connect</p>
                    <h3 class="text-xl font-semibold text-foreground">Write config directly to Claude Desktop</h3>
                    <p class="text-sm text-muted-foreground">FCC will drop the latest MCP configuration into Claude&rsquo;s folder and create a timestamped backup before replacing anything.</p>
                </div>
                <button type="button" class="rounded-full border border-border/70 p-1 text-muted-foreground transition hover:text-foreground" data-claude-close>
                    <i data-lucide="x" class="h-4 w-4"></i>
                </button>
            </div>
            <div class="space-y-5 px-6 py-6">
                <div class="rounded-xl border border-border/70 bg-muted/50 p-4">
                    <p class="text-xs font-semibold uppercase tracking-[0.28em] text-muted-foreground">Destination</p>
                    <p id="claude-config-path" class="mt-2 break-all font-mono text-xs text-foreground">Detecting Claude folder…</p>
                    <p id="claude-config-meta" class="text-xs text-muted-foreground">Launch Claude Desktop once if this path doesn&rsquo;t exist yet.</p>
                </div>
                <div class="rounded-xl border border-amber-200 bg-amber-50/90 p-4 text-sm text-amber-900">
                    <p class="font-medium">What to expect</p>
                    <p class="mb-2">FCC replaces <code>claude_desktop_config.json</code> in place. Before writing, it saves a backup such as <code>claude_desktop_config.backup-2025-01-09.json</code> so you can roll back inside this dialog.</p>
                    <p><strong>Important:</strong> Quit Claude Desktop completely before clicking Connect (Windows: Task&nbsp;Manager → “End task”, macOS: Command+Q or Activity Monitor). This prevents file-lock issues.</p>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label for="claude-backup-select" class="text-sm font-medium text-foreground">Available backups</label>
                        <button type="button" id="claude-refresh-backups" class="text-xs font-medium text-primary transition hover:text-primary/80">Refresh</button>
                    </div>
                    <select id="claude-backup-select" class="w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground">
                        <option value="">No backups detected yet</option>
                    </select>
                    <button type="button" id="claude-restore-btn" class="inline-flex w-full items-center justify-center gap-2 rounded-lg border border-border/70 bg-background px-3 py-2 text-sm font-medium text-foreground transition hover:bg-background/80 disabled:cursor-not-allowed disabled:opacity-60">
                        <i data-lucide="history" class="h-4 w-4"></i>
                        <span>Restore selected backup</span>
                    </button>
                </div>
                <div id="claude-connect-status" data-base-class="rounded-lg border px-4 py-3 text-sm" class="hidden rounded-lg border px-4 py-3 text-sm"></div>
                <div class="flex flex-col justify-end gap-3 border-t border-border/60 pt-4 sm:flex-row">
                    <button type="button" class="inline-flex items-center justify-center gap-2 rounded-lg border border-border/70 bg-background px-4 py-2 text-sm font-medium text-foreground transition hover:bg-background/80" data-claude-close>
                        <i data-lucide="arrow-left" class="h-4 w-4"></i>
                        <span>Cancel</span>
                    </button>
                    <button type="button" id="claude-connect-confirm" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                        <i data-lucide="plug" class="h-4 w-4"></i>
                        <span>Connect now</span>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}


{% block body_scripts %}
    {{ super() }}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const generateBtn = document.getElementById('claude-generate-btn');
        const connectBtn = document.getElementById('claude-connect-btn');
        const connectModal = document.getElementById('claude-connect-modal');
        const connectConfirmBtn = document.getElementById('claude-connect-confirm');
        const connectStatusEl = document.getElementById('claude-connect-status');
        const connectStatusBase = connectStatusEl ? connectStatusEl.dataset.baseClass || '' : '';
        const configPathEl = document.getElementById('claude-config-path');
        const configMetaEl = document.getElementById('claude-config-meta');
        const backupSelect = document.getElementById('claude-backup-select');
        const restoreBtn = document.getElementById('claude-restore-btn');
        const refreshBackupsBtn = document.getElementById('claude-refresh-backups');
        const modalCloseButtons = document.querySelectorAll('[data-claude-close]');
        const downloadBtn = document.getElementById('claude-download-btn');
        const summaryEl = document.getElementById('claude-config-summary');
        const summaryBase = summaryEl ? summaryEl.dataset.baseClass || '' : '';
        let configData = null;

        const friendlyIntegrations = {
          stripe: 'Stripe payments',
          xero: 'Xero accounting',
          plaid: 'Plaid banking',
        };

        const formatLabel = (value) => {
          const key = (value || '').toLowerCase();
          if (friendlyIntegrations[key]) {
            return friendlyIntegrations[key];
          }
          return key.replace(/_/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase());
        };

        const humanizeTimestamp = (value) => {
          if (!value) return 'Not written yet';
          try {
            return new Date(value).toLocaleString();
          } catch (error) {
            return value;
          }
        };

        const toggleConnectModal = (show = false) => {
          if (!connectModal) return;
          connectModal.classList.toggle('hidden', !show);
          document.body.classList.toggle('overflow-hidden', show);
          if (show) {
            refreshPathStatus();
          } else {
            setModalStatus('');
          }
        };

        const setModalStatus = (html, tone = 'info') => {
          if (!connectStatusEl) return;
          if (!html) {
            connectStatusEl.classList.add('hidden');
            connectStatusEl.innerHTML = '';
            return;
          }
          const toneClasses = {
            success: 'border-emerald-200 bg-emerald-50 text-emerald-700',
            error: 'border-rose-200 bg-rose-50 text-rose-700',
            warning: 'border-amber-200 bg-amber-50 text-amber-900',
            info: 'border-border/60 bg-muted/60 text-muted-foreground',
          };
          connectStatusEl.className = `${connectStatusBase} ${toneClasses[tone] || toneClasses.info}`.trim();
          connectStatusEl.innerHTML = html;
          connectStatusEl.classList.remove('hidden');
        };

        const setModalLoading = (isLoading) => {
          if (!connectConfirmBtn) return;
          const label = connectConfirmBtn.querySelector('span');
          connectConfirmBtn.disabled = isLoading;
          connectConfirmBtn.classList.toggle('opacity-70', isLoading);
          connectConfirmBtn.classList.toggle('cursor-not-allowed', isLoading);
          if (label) {
            if (isLoading) {
              connectConfirmBtn.dataset.originalLabel = label.textContent.trim();
              label.textContent = 'Connecting…';
            } else if (connectConfirmBtn.dataset.originalLabel) {
              label.textContent = connectConfirmBtn.dataset.originalLabel;
              delete connectConfirmBtn.dataset.originalLabel;
            }
          }
        };

        const renderBackups = (backups = []) => {
          if (!backupSelect) return;
          backupSelect.innerHTML = '';
          if (!backups.length) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No backups detected yet';
            backupSelect.appendChild(option);
            backupSelect.disabled = true;
            if (restoreBtn) {
              restoreBtn.disabled = true;
            }
            return;
          }
          backups.forEach((backup) => {
            const option = document.createElement('option');
            option.value = backup.path;
            option.textContent = `${backup.label} · ${humanizeTimestamp(backup.last_modified)}`;
            backupSelect.appendChild(option);
          });
          backupSelect.disabled = false;
          if (restoreBtn) {
            restoreBtn.disabled = false;
          }
        };

        const updatePathDetails = (status) => {
          if (configPathEl) {
            configPathEl.textContent = status?.path || 'Not detected yet';
          }
          if (configMetaEl) {
            if (status?.exists) {
              configMetaEl.textContent = `Last updated ${humanizeTimestamp(status.last_modified)} · ${status.bytes || 0} bytes`;
            } else if (status?.directory_exists) {
              configMetaEl.textContent = 'Directory available—ready to write configuration.';
            } else {
              configMetaEl.textContent = 'Directory missing—launch Claude Desktop once, then retry.';
            }
          }
          renderBackups(status?.backups || []);
        };

        const refreshPathStatus = async (providedStatus = null) => {
          if (providedStatus) {
            updatePathDetails(providedStatus);
            return;
          }
          try {
            const response = await fetch('/api/claude/config-path');
            const data = await response.json();
            if (!response.ok || !data.success) {
              throw new Error(data.message || 'Unable to read Claude Desktop folder.');
            }
            updatePathDetails(data.status);
          } catch (error) {
            setModalStatus(`
              <div class="space-y-1">
                <p class="font-medium">Could not detect Claude Desktop folder.</p>
                <p>${error.message}</p>
              </div>
            `, 'error');
          }
        };

        function setLoading(isLoading) {
          if (!generateBtn) return;
          const label = generateBtn.querySelector('span');
          generateBtn.disabled = isLoading;
          generateBtn.classList.toggle('opacity-70', isLoading);
          generateBtn.classList.toggle('cursor-not-allowed', isLoading);
          generateBtn.setAttribute('aria-busy', String(isLoading));
          if (label) {
            if (isLoading) {
              generateBtn.dataset.originalLabel = label.textContent.trim();
              label.textContent = 'Generating…';
            } else if (generateBtn.dataset.originalLabel) {
              label.textContent = generateBtn.dataset.originalLabel;
              delete generateBtn.dataset.originalLabel;
            }
          }
        }

        function showMessage(html, tone = 'info') {
          if (!summaryEl) return;
          const toneClasses = {
            success: 'border-emerald-200 bg-emerald-50 text-emerald-700',
            error: 'border-rose-200 bg-rose-50 text-rose-700',
            info: 'border-border/60 bg-muted/60 text-muted-foreground',
          };
          summaryEl.className = `${summaryBase} ${toneClasses[tone] || toneClasses.info}`.trim();
          summaryEl.innerHTML = html;
          summaryEl.classList.remove('hidden');
        }

        generateBtn?.addEventListener('click', async () => {
          setLoading(true);
          showMessage('<p class="font-medium">Generating configuration…</p>', 'info');
          try {
            const response = await fetch('/api/claude/generate-config');
            const data = await response.json();
            if (!response.ok || !data.success) {
              throw new Error(data.message || 'Failed to generate configuration');
            }
            configData = data.config;
            const servers = (data.summary?.servers || []).map((name) => `<code>${name}</code>`).join(', ');
            const integrations = data.summary?.integrations || {};
            const integrationSummary = Object.entries(integrations).map(([key, details]) => {
              const state = details.configured ? 'Connected' : (details.skipped ? 'Skipped' : 'Pending');
              const endpoint = details.configured ? `/sync/${key}` : null;
              return `<li>${formatLabel(key)}: <span class="font-medium">${state}</span>${endpoint ? ` &ndash; <code>${endpoint}</code>` : ''}</li>`;
            }).join('') || '<li>No integrations configured yet.</li>';
            const pythonInfo = data.summary?.python_executable || 'python';
            const content = `
              <div class="space-y-2">
                <p class="font-medium text-foreground">Configuration generated successfully.</p>
                <ul class="space-y-1">
                  <li>Servers included: ${servers || 'None'}</li>
                  <li>Python executable: <code>${pythonInfo}</code></li>
                </ul>
                <div class="space-y-1">
                  <p class="font-medium text-foreground">Integration status</p>
                  <ul class="list-disc pl-5 space-y-1 text-muted-foreground">
                    ${integrationSummary}
                  </ul>
                </div>
              </div>
            `;
            showMessage(content, 'success');
            if (downloadBtn) {
              downloadBtn.classList.remove('hidden');
              downloadBtn.focus();
            }
          } catch (error) {
            showMessage(`
              <div class="space-y-1">
                <p class="font-medium">Could not generate configuration.</p>
                <p>${error.message}</p>
              </div>
            `, 'error');
          } finally {
            setLoading(false);
          }
        });

        downloadBtn?.addEventListener('click', () => {
          if (!configData) {
            showMessage('<p>Please generate a configuration before downloading.</p>', 'error');
            return;
          }
          const blob = new Blob([configData], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement('a');
          anchor.href = url;
          anchor.download = 'claude_desktop_config.json';
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
          URL.revokeObjectURL(url);
        });

        connectBtn?.addEventListener('click', () => toggleConnectModal(true));
        modalCloseButtons?.forEach((button) => {
          button.addEventListener('click', () => toggleConnectModal(false));
        });
        connectModal?.addEventListener('click', (event) => {
          if (event.target === connectModal) {
            toggleConnectModal(false);
          }
        });

        const performConnect = async () => {
          setModalStatus('<p class="font-medium">Writing configuration to Claude Desktop…</p>', 'info');
          setModalLoading(true);
          try {
            const response = await fetch('/api/claude/connect', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({}),
            });
            const data = await response.json();
            if (!response.ok || !data.success) {
              throw new Error(data.message || 'Failed to connect Claude automatically.');
            }
            if (data.config) {
              configData = data.config;
              downloadBtn?.classList.remove('hidden');
            }
            setModalStatus(`
              <div class="space-y-1">
                <p class="font-medium text-foreground">Claude Desktop configuration updated.</p>
                <p class="text-xs text-muted-foreground">Path: <span class="font-mono">${data.path}</span></p>
                ${data.backup_path ? `<p class="text-xs text-muted-foreground">Backup: <span class="font-mono">${data.backup_path}</span></p>` : ''}
              </div>
            `, 'success');
            showMessage('<p class="font-medium text-foreground">Claude Desktop connected successfully. Your MCP servers are now registered.</p>', 'success');
            refreshPathStatus(data.status);
          } catch (error) {
            setModalStatus(`
              <div class="space-y-1">
                <p class="font-medium">Could not write configuration.</p>
                <p>${error.message}</p>
              </div>
            `, 'error');
          } finally {
            setModalLoading(false);
          }
        };

        connectConfirmBtn?.addEventListener('click', performConnect);

        restoreBtn?.addEventListener('click', async () => {
          if (!backupSelect || !backupSelect.value) {
            setModalStatus('<p>Please select a backup to restore.</p>', 'warning');
            return;
          }
          setModalStatus('<p class="font-medium">Restoring selected backup…</p>', 'info');
          restoreBtn.disabled = true;
          try {
            const response = await fetch('/api/claude/restore', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ backup_path: backupSelect.value }),
            });
            const data = await response.json();
            if (!response.ok || !data.success) {
              throw new Error(data.message || 'Unable to restore backup.');
            }
            setModalStatus('<p class="font-medium text-foreground">Backup restored successfully.</p>', 'success');
            refreshPathStatus(data.status);
          } catch (error) {
            setModalStatus(`
              <div class="space-y-1">
                <p class="font-medium">Could not restore backup.</p>
                <p>${error.message}</p>
              </div>
            `, 'error');
          } finally {
            restoreBtn.disabled = false;
          }
        });

        refreshBackupsBtn?.addEventListener('click', () => refreshPathStatus());
      });
    </script>
{% endblock %}
