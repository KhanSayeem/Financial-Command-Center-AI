{% extends "layout.html" %}

{% block title %}Admin Dashboard · Financial Command Center AI{% endblock %}

{% set stats = stats or [] %}
{% set api_keys = api_keys or [] %}
{% set recent_events = recent_events or [] %}
{% set quick_links = quick_links or [] %}

{% block content %}
<div class="flex flex-col gap-10">
    <div class="card border border-border/70 p-7 shadow-card">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-medium uppercase tracking-[0.28em] text-muted-foreground">
                    <i data-lucide="badge-check" class="h-3.5 w-3.5"></i>
                    Admin Control Center
                </span>
                <div class="space-y-2">
                    <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Monitor access and keep API credentials on track</h1>
                    <p class="text-base text-muted-foreground sm:text-lg">Issue secure keys, audit usage, and jump into health checks without leaving the browser.</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                    <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground">{{ mode_label }}</span>
                    {% if security_enabled %}
                        <span class="inline-flex items-center gap-2 text-sm font-medium text-emerald-600"><i data-lucide="shield-check" class="h-4 w-4"></i>Security layer active</span>
                    {% else %}
                        <span class="inline-flex items-center gap-2 text-sm font-medium text-amber-600"><i data-lucide="shield-alert" class="h-4 w-4"></i>Security module disabled</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex flex-col gap-3 sm:flex-row">
                <a href="/admin/create-demo-key" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                    <i data-lucide="key" class="h-4 w-4"></i>
                    Create demo key
                </a>
                <a href="/health" class="inline-flex items-center justify-center gap-2 rounded-lg border border-border/70 bg-card px-5 py-2.5 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80">
                    <i data-lucide="activity" class="h-4 w-4"></i>
                    Run health check
                </a>
            </div>
        </div>
    </div>

    {% if not security_enabled %}
        <div class="rounded-xl border border-amber-200 bg-amber-50/70 p-4 text-sm text-amber-800">
            <div class="flex items-start gap-3">
                <i data-lucide="shield-off" class="mt-0.5 h-4 w-4"></i>
                <div>
                    <p class="font-semibold">Security module inactive</p>
                    <p class="mt-1">Install <code>auth/security.py</code> and enable the security layer to provision real API keys and audit every request.</p>
                </div>
            </div>
        </div>
    {% endif %}

    {% if stats %}
        {% set tone_map = {
            'default': 'border-border/70 bg-card/70 text-foreground',
            'success': 'border-emerald-200 bg-emerald-50 text-emerald-700',
            'warning': 'border-amber-200 bg-amber-50 text-amber-700',
            'info': 'border-sky-200 bg-sky-50 text-sky-700'
        } %}
        <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
            {% for stat in stats %}
                {% set tone = tone_map.get(stat.tone or 'default') %}
                <div class="card border border-border/70 p-6">
                    <div class="flex items-center gap-3">
                        <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full {{ tone }}">
                            {% if stat.icon %}<i data-lucide="{{ stat.icon }}" class="h-5 w-5"></i>{% endif %}
                        </span>
                        <div>
                            <p class="text-sm font-medium text-muted-foreground">{{ stat.label }}</p>
                            <p class="text-2xl font-semibold leading-none tracking-tight">{{ stat.value }}</p>
                        </div>
                    </div>
                    {% if stat.description %}
                        <p class="mt-3 text-sm text-muted-foreground">{{ stat.description }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="grid gap-6 lg:grid-cols-[minmax(0,1.05fr)_minmax(0,0.75fr)]">
        <section class="card border border-border/70 p-0">
            <div class="flex items-center justify-between gap-3 border-b border-border/70 px-6 py-4">
                <div>
                    <h2 class="text-lg font-semibold text-foreground">API keys</h2>
                    <p class="text-sm text-muted-foreground">Rotate credentials, review scopes, and monitor usage.</p>
                </div>
                <a href="/admin/create-demo-key" class="inline-flex items-center gap-2 rounded-lg border border-border/70 px-3 py-2 text-xs font-medium text-muted-foreground transition hover:text-foreground">
                    <i data-lucide="plus" class="h-3.5 w-3.5"></i>
                    New key
                </a>
            </div>
            {% if api_keys %}
                <div class="divide-y divide-border/70">
                    {% for key in api_keys %}
                        <div class="flex flex-col gap-4 px-6 py-5 sm:flex-row sm:items-center sm:justify-between">
                            <div class="space-y-2">
                                <div class="flex items-center gap-3">
                                    <span class="inline-flex items-center gap-2 rounded-full border border-border/60 bg-muted/60 px-3 py-1 text-xs font-medium text-muted-foreground">{{ key.mask }}</span>
                                    <span class="text-sm font-semibold text-foreground">{{ key.client_name }}</span>
                                    <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-medium {{ 'bg-emerald-50 text-emerald-700 border border-emerald-200' if key.active else 'bg-rose-50 text-rose-700 border border-rose-200' }}">
                                        <i data-lucide="{{ 'check' if key.active else 'pause' }}" class="h-3.5 w-3.5"></i>
                                        {{ 'Active' if key.active else 'Inactive' }}
                                    </span>
                                </div>
                                <div class="flex flex-wrap gap-4 text-xs text-muted-foreground">
                                    <span class="inline-flex items-center gap-1"><i data-lucide="calendar" class="h-3.5 w-3.5"></i>Issued {{ key.created_at or 'unknown' }}</span>
                                    <span class="inline-flex items-center gap-1"><i data-lucide="clock" class="h-3.5 w-3.5"></i>Last used {{ key.last_used or 'never' }}</span>
                                    {% if key.daily_limit %}
                                        <span class="inline-flex items-center gap-1"><i data-lucide="timer" class="h-3.5 w-3.5"></i>{{ key.daily_limit }} daily limit</span>
                                    {% endif %}
                                </div>
                                {% if key.permissions %}
                                    <div class="flex flex-wrap gap-2 text-xs">
                                        {% for perm in key.permissions %}
                                            <span class="inline-flex items-center gap-1 rounded-full border border-border/70 bg-muted/70 px-2.5 py-1 text-muted-foreground">
                                                <i data-lucide="sparkles" class="h-3 w-3"></i>{{ perm }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs text-muted-foreground">
                                {% if key.monthly_limit %}
                                    <span class="flex items-center gap-1 rounded-lg border border-border/70 px-2.5 py-1">
                                        <i data-lucide="target" class="h-3.5 w-3.5"></i>
                                        {{ key.monthly_limit }} / month
                                    </span>
                                {% endif %}
                                <span class="flex items-center gap-1 rounded-lg border border-border/70 px-2.5 py-1">
                                    <i data-lucide="shield" class="h-3.5 w-3.5"></i>
                                    Signed
                                </span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="flex flex-col items-center justify-center gap-3 px-6 py-16 text-center text-sm text-muted-foreground">
                    <i data-lucide="key" class="h-6 w-6"></i>
                    <p>No API keys yet. Generate a demo key to start testing secure requests.</p>
                </div>
            {% endif %}
        </section>

        <aside class="flex flex-col gap-6">
            <div class="card border border-border/70 p-6">
                <div class="flex items-center justify-between gap-3">
                    <h2 class="text-lg font-semibold text-foreground">Recent activity</h2>
                    <span class="text-xs font-medium text-muted-foreground">Last {{ recent_events|length }} events</span>
                </div>
                {% if recent_events %}
                    <ul class="mt-4 space-y-4">
                        {% for event in recent_events %}
                            <li class="flex gap-3 rounded-lg border border-border/70 bg-muted/60 p-3 text-sm">
                                <span class="mt-0.5 inline-flex h-2.5 w-2.5 flex-shrink-0 rounded-full {{ 'bg-emerald-500' if event.tone == 'success' else 'bg-amber-500' if event.tone == 'warning' else 'bg-rose-500' }}"></span>
                                <div class="space-y-1">
                                    <div class="flex flex-wrap items-center gap-2 text-xs text-muted-foreground">
                                        <span>{{ event.timestamp }}</span>
                                        <span>•</span>
                                        <span>{{ event.client_name }}</span>
                                    </div>
                                    <p class="font-medium text-foreground">{{ event.event_type }}</p>
                                    {% if event.details %}
                                        <p class="text-xs text-muted-foreground">{{ event.details }}</p>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="mt-6 flex flex-col items-center gap-2 text-sm text-muted-foreground">
                        <i data-lucide="history" class="h-5 w-5"></i>
                        <p>No security events yet. Activity will appear once API calls are made.</p>
                    </div>
                {% endif %}
            </div>

            <div class="card border border-border/70 p-6">
                <h2 class="text-lg font-semibold text-foreground">Quick links</h2>
                <div class="mt-4 grid gap-3">
                    {% for link in quick_links %}
                        <a href="{{ link.href }}" class="group flex flex-col gap-2 rounded-lg border border-border/70 px-4 py-3 text-sm font-medium text-foreground transition hover:border-primary/50 hover:bg-primary/5">
                            <span class="flex items-center gap-2">
                                {% if link.icon %}<i data-lucide="{{ link.icon }}" class="h-4 w-4 text-primary transition group-hover:translate-x-0.5"></i>{% endif %}
                                {{ link.label }}
                            </span>
                            {% if link.description %}
                                <span class="text-xs text-muted-foreground">{{ link.description }}</span>
                            {% endif %}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </aside>
    </div>
</div>
{% endblock %}
