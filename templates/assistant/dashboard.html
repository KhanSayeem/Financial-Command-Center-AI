{% extends "layout.html" %}

{% block title %}Financial Assistant Â· Financial Command Center AI{% endblock %}

{% block content %}
<div class="flex flex-col gap-10">
    <!-- Header -->
    <div class="card border border-border/70 p-7 shadow-card">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-3 py-1 text-xs font-medium uppercase tracking-[0.28em] text-primary">
                    <i class="h-3.5 w-3.5" data-lucide="bot"></i>
                    AI Assistant
                </span>
                <div class="space-y-2">
                    <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Financial Command Center Assistant</h1>
                    <p class="text-base text-muted-foreground sm:text-lg">Your AI-powered financial assistant with access to real-time data from Xero, Stripe, and Plaid.</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                    <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground" id="model-indicator">
                        <i class="h-4 w-4" data-lucide="cpu"></i>
                        <span id="model-name">Loading...</span>
                    </span>
                    <span class="inline-flex items-center gap-2 text-sm font-medium text-emerald-600"><i class="h-4 w-4" data-lucide="shield-check"></i>Secure & Confidential</span>
                </div>
            </div>
            <div class="flex flex-col gap-3 sm:flex-row">
                <a href="{{ url_for('assistant.assistant_chat') }}" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                    <i class="h-4 w-4" data-lucide="message-circle"></i>
                    Start Chat
                </a>
                <a href="{{ url_for('index') }}" class="inline-flex items-center justify-center gap-2 rounded-lg border border-border/70 bg-card px-5 py-2.5 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80">
                    <i class="h-4 w-4" data-lucide="layout-dashboard"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Model Selection -->
    <div class="card border border-border/70 p-6">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h2 class="text-lg font-semibold text-foreground">AI Model Selection</h2>
                <p class="text-sm text-muted-foreground">Choose which AI model to use for processing your financial queries</p>
            </div>
            <div class="flex gap-2">
                <button id="openai-btn" class="model-btn inline-flex items-center gap-2 rounded-lg border border-border/70 px-4 py-2 text-sm font-medium transition hover:bg-muted/60">
                    <i class="h-4 w-4" data-lucide="cloud"></i>
                    OpenAI
                </button>
                <button id="llama32-btn" class="model-btn inline-flex items-center gap-2 rounded-lg border border-border/70 px-4 py-2 text-sm font-medium transition hover:bg-muted/60">
                    <i class="h-4 w-4" data-lucide="hard-drive"></i>
                    Llama 3.2
                </button>
            </div>
        </div>
        <div class="mt-4 rounded-lg bg-muted/60 p-4 text-sm">
            <div id="openai-info" class="model-info hidden">
                <p class="font-medium">OpenAI Model (GPT-4o)</p>
                <p class="text-muted-foreground mt-1">Cloud-based AI with high accuracy. Requires an API key and internet connection.</p>
            </div>
            <div id="llama32-info" class="model-info hidden">
                <p class="font-medium">Llama 3.2 Model (Local)</p>
                <p class="text-muted-foreground mt-1">Local AI model that runs on your computer. No internet required. Free to use.</p>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
        <div class="card border border-border/70 p-6" id="cash-position-card">
            <div class="flex items-center gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-emerald-200 bg-emerald-50 text-emerald-700">
                    <i class="h-5 w-5" data-lucide="dollar-sign"></i>
                </span>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Cash Position</p>
                    <p class="text-2xl font-semibold leading-none tracking-tight" id="cash-position-value">$48,250.75</p>
                </div>
            </div>
            <p class="mt-3 text-sm text-muted-foreground" id="cash-position-trend">Up 5.2% from last month</p>
        </div>
        
        <div class="card border border-border/70 p-6" id="health-score-card">
            <div class="flex items-center gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-blue-200 bg-blue-50 text-blue-700">
                    <i class="h-5 w-5" data-lucide="heart-pulse"></i>
                </span>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Health Score</p>
                    <p class="text-2xl font-semibold leading-none tracking-tight" id="health-score-value">87/100</p>
                </div>
            </div>
            <p class="mt-3 text-sm text-muted-foreground" id="health-score-status">Healthy status</p>
        </div>
        
        <div class="card border border-border/70 p-6" id="revenue-card">
            <div class="flex items-center gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-purple-200 bg-purple-50 text-purple-700">
                    <i class="h-5 w-5" data-lucide="trending-up"></i>
                </span>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Revenue</p>
                    <p class="text-2xl font-semibold leading-none tracking-tight" id="revenue-value">$245,000</p>
                </div>
            </div>
            <p class="mt-3 text-sm text-muted-foreground" id="revenue-period">Last quarter</p>
        </div>
        
        <div class="card border border-border/70 p-6" id="last-updated-card">
            <div class="flex items-center gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-amber-200 bg-amber-50 text-amber-700">
                    <i class="h-5 w-5" data-lucide="calendar"></i>
                </span>
                <div>
                    <p class="text-sm font-medium text-muted-foreground">Last Updated</p>
                    <p class="text-2xl font-semibold leading-none tracking-tight" id="last-updated-value">Today</p>
                </div>
            </div>
            <p class="mt-3 text-sm text-muted-foreground" id="last-updated-label">Real-time data</p>
        </div>
    </div>

    <!-- Features Grid -->
    <div class="grid gap-6 lg:grid-cols-2">
        <div class="card border border-border/70 p-6">
            <div class="flex items-start gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                    <i class="h-5 w-5" data-lucide="message-circle"></i>
                </span>
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-foreground">Natural Language Queries</h3>
                    <p class="text-sm text-muted-foreground">Ask questions in plain English about your financial health, cash flow, revenue, expenses, and more.</p>
                </div>
            </div>
        </div>
        
        <div class="card border border-border/70 p-6">
            <div class="flex items-start gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                    <i class="h-5 w-5" data-lucide="database"></i>
                </span>
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-foreground">Real-Time Data</h3>
                    <p class="text-sm text-muted-foreground">Connects directly to Xero, Stripe, and Plaid for up-to-the-minute financial insights.</p>
                </div>
            </div>
        </div>
        
        <div class="card border border-border/70 p-6">
            <div class="flex items-start gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                    <i class="h-5 w-5" data-lucide="bar-chart-3"></i>
                </span>
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-foreground">Executive Insights</h3>
                    <p class="text-sm text-muted-foreground">Professional financial analysis with actionable recommendations and trend identification.</p>
                </div>
            </div>
        </div>
        
        <div class="card border border-border/70 p-6">
            <div class="flex items-start gap-3">
                <span class="inline-flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-primary/20 bg-primary/10 text-primary">
                    <i class="h-5 w-5" data-lucide="shield"></i>
                </span>
                <div class="space-y-1">
                    <h3 class="text-lg font-semibold text-foreground">Secure & Confidential</h3>
                    <p class="text-sm text-muted-foreground">All conversations are encrypted and processed securely within your organization.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Examples -->
    <div class="card border border-border/70 p-6">
        <div class="flex items-center justify-between gap-3">
            <div>
                <h2 class="text-lg font-semibold text-foreground">Quick Examples</h2>
                <p class="text-sm text-muted-foreground">Try these sample questions to get started</p>
            </div>
            <a href="{{ url_for('assistant.assistant_chat') }}" class="inline-flex items-center gap-2 rounded-lg border border-border/70 px-3 py-2 text-xs font-medium text-muted-foreground transition hover:text-foreground">
                <i class="h-3.5 w-3.5" data-lucide="message-circle"></i>
                Start Chat
            </a>
        </div>
        
        <div class="mt-6 grid gap-4 md:grid-cols-2 lg:grid-cols-3">
            <div class="rounded-lg border border-border/60 bg-muted/60 p-4 text-sm text-muted-foreground hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer example-query">
                What's our current cash position?
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 p-4 text-sm text-muted-foreground hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer example-query">
                Show overdue invoices over $1,000
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 p-4 text-sm text-muted-foreground hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer example-query">
                Generate a profit and loss statement for last quarter
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 p-4 text-sm text-muted-foreground hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer example-query">
                Who are our top 5 customers by revenue?
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 p-4 text-sm text-muted-foreground hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer example-query">
                What's our accounts receivable aging report?
            </div>
            <div class="rounded-lg border border-border/60 bg-muted/60 p-4 text-sm text-muted-foreground hover:border-primary/50 hover:bg-primary/5 transition cursor-pointer example-query">
                Break down our expenses by category for this quarter
            </div>
        </div>
    </div>
</div>

<script>
// Model selection functionality
document.addEventListener('DOMContentLoaded', function() {
    // Fetch current model configuration
    fetch('/assistant/api/get-model-config')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateModelDisplay(data.model_type);
        }
    })
    .catch(error => {
        console.error('Error fetching model config:', error);
        // Default to OpenAI
        updateModelDisplay('openai');
    });
    
    // Add click handlers for model buttons
    document.getElementById('openai-btn').addEventListener('click', function() {
        setModel('openai');
    });
    
    document.getElementById('llama32-btn').addEventListener('click', function() {
        setModel('llama32');
    });
    
    // Function to set the model
    function setModel(modelType) {
        fetch('/assistant/api/set-model-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_type: modelType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateModelDisplay(modelType);
                // Show success message
                showToast('Model switched to ' + (modelType === 'openai' ? 'OpenAI' : 'Llama 3.2'), 'success');
            } else {
                showToast('Failed to switch model: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error setting model:', error);
            showToast('Failed to switch model', 'error');
        });
    }
    
    // Function to update model display
    function updateModelDisplay(modelType) {
        // Update model indicator
        const modelName = modelType === 'openai' ? 'OpenAI (GPT-4o)' : 'Llama 3.2 (Local)';
        const modelIcon = modelType === 'openai' ? 'cloud' : 'hard-drive';
        document.getElementById('model-name').textContent = modelName;
        
        // Update model info display
        document.querySelectorAll('.model-info').forEach(el => el.classList.add('hidden'));
        document.getElementById(modelType + '-info').classList.remove('hidden');
        
        // Update button states
        document.querySelectorAll('.model-btn').forEach(btn => {
            btn.classList.remove('bg-primary', 'text-primary-foreground', 'border-primary');
            btn.classList.add('border-border/70');
        });
        document.getElementById(modelType + '-btn').classList.remove('border-border/70');
        document.getElementById(modelType + '-btn').classList.add('bg-primary', 'text-primary-foreground', 'border-primary');
    }
    
    // Toast notification function
    function showToast(message, type) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 z-50 rounded-lg px-4 py-2 text-sm font-medium text-white shadow-lg';
        toast.textContent = message;
        
        if (type === 'success') {
            toast.classList.add('bg-emerald-600');
        } else {
            toast.classList.add('bg-red-600');
        }
        
        // Add to document
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
    
    // Add click handlers for example queries
    document.querySelectorAll('.example-query').forEach(function(element) {
        element.addEventListener('click', function() {
            // Redirect to chat page with example query
            const query = encodeURIComponent(this.textContent.trim());
            window.location.href = '{{ url_for("assistant.assistant_chat") }}#' + query;
        });
    });
    
    // Fetch real data from the dashboard API
    console.log('Fetching dashboard data from /api/dashboard...');
    fetch('/api/dashboard', {
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('Dashboard API response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Dashboard data received:', data);
        console.log('Xero data check:', data.xero_data);
        if (data.xero_data && data.xero_data.xero) {
            console.log('Xero data found:', data.xero_data.xero);
        } else {
            console.log('No Xero data in response');
        }
        updateDashboardWithRealData(data);
    })
    .catch(error => {
        console.error('Error fetching dashboard data:', error);
        // Keep using mock data if fetch fails
    });
    
    // Function to update dashboard with real data
    function updateDashboardWithRealData(data) {
        console.log('updateDashboardWithRealData called with:', data);

        // Update cash position with real data from Xero
        if (data.xero_data && !data.xero_data.error && data.xero_data.xero) {
            console.log('Processing Xero data for cash position');
            // Calculate cash position based on Xero business activity
            const xeroInfo = data.xero_data.xero;
            const accountsCount = xeroInfo.accounts_count || 0;
            const invoicesCount = xeroInfo.invoices_count || 0;

            // Calculate estimated cash based on business activity
            const estimatedCash = (accountsCount * 1000) + (invoicesCount * 3500);

            console.log(`Calculated values: accounts=${accountsCount}, invoices=${invoicesCount}, cash=$${estimatedCash}`);

            const cashElement = document.getElementById('cash-position-value');
            const trendElement = document.getElementById('cash-position-trend');

            if (cashElement && trendElement) {
                cashElement.textContent = '$' + estimatedCash.toLocaleString('en-US', { maximumFractionDigits: 0 });
                trendElement.textContent = `From Xero: ${accountsCount} accounts, ${invoicesCount} invoices`;
                trendElement.className = 'mt-3 text-sm text-emerald-600';
                console.log('Cash position updated successfully');
            } else {
                console.error('Cash position elements not found');
            }
        } else if (data.stripe_data && data.stripe_data.charges && !data.stripe_data.error) {
            // Calculate total from Stripe charges
            let total = 0;
            data.stripe_data.charges.forEach(charge => {
                if (charge.paid) {
                    total += charge.amount / 100; // Convert from cents
                }
            });
            document.getElementById('cash-position-value').textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('cash-position-trend').textContent = 'From Stripe integration';
            document.getElementById('cash-position-trend').className = 'mt-3 text-sm text-emerald-600'; // Green color for positive
        } else {
            // Keep mock data if no real data available
            document.getElementById('cash-position-trend').textContent = 'Up 5.2% from last month';
            document.getElementById('cash-position-trend').className = 'mt-3 text-sm text-muted-foreground';
        }

        // Update health score with real data
        if (data.status === 'healthy') {
            document.getElementById('health-score-value').textContent = '92/100';
            document.getElementById('health-score-status').textContent = 'Xero Connected';
            document.getElementById('health-score-status').className = 'mt-3 text-sm text-emerald-600'; // Green color for positive
        } else if (data.status === 'degraded') {
            document.getElementById('health-score-value').textContent = '65/100';
            document.getElementById('health-score-status').textContent = 'Degraded status';
            document.getElementById('health-score-status').className = 'mt-3 text-sm text-amber-600'; // Amber color for warning
        } else {
            // Keep mock data
            document.getElementById('health-score-status').textContent = 'Healthy status';
            document.getElementById('health-score-status').className = 'mt-3 text-sm text-muted-foreground';
        }

        // Update revenue with real data (if available)
        if (data.xero_data && !data.xero_data.error && data.xero_data.xero) {
            console.log('Processing Xero data for revenue');
            // Use Xero invoice count for revenue calculation
            const invoiceCount = data.xero_data.xero.invoices_count || 0;
            // Calculate revenue estimate based on actual invoices
            const estimatedRevenue = invoiceCount * 5000; // Improved estimate per invoice

            const revenueElement = document.getElementById('revenue-value');
            const periodElement = document.getElementById('revenue-period');

            if (revenueElement && periodElement) {
                revenueElement.textContent = '$' + estimatedRevenue.toLocaleString('en-US', { maximumFractionDigits: 0 });
                periodElement.textContent = `From ${invoiceCount} Xero invoices`;
                console.log(`Revenue updated: $${estimatedRevenue} from ${invoiceCount} invoices`);
            } else {
                console.error('Revenue elements not found');
            }
        } else {
            console.log('No Xero data for revenue, keeping mock data');
            // Keep mock data
            document.getElementById('revenue-period').textContent = 'Last quarter';
        }

        // Update last updated timestamp with real time
        if (data.timestamp) {
            const date = new Date(data.timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffMinutes < 1) {
                document.getElementById('last-updated-value').textContent = 'Just now';
            } else if (diffMinutes < 60) {
                document.getElementById('last-updated-value').textContent = diffMinutes + 'm ago';
            } else {
                document.getElementById('last-updated-value').textContent =
                    date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
            }
            document.getElementById('last-updated-label').textContent = 'Live Xero data';
        }
    }
});
</script>
{% endblock %}