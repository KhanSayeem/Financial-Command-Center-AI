{% extends "layout.html" %}

{% block title %}Financial Dashboard Â· Financial Command Center AI{% endblock %}

{% block head_extra %}
<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">
    <!-- Header -->
    <div class="card border border-border/70 p-7 shadow-card">
        <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
            <div class="space-y-3">
                <span class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-3 py-1 text-xs font-medium uppercase tracking-[0.28em] text-primary">
                    <i class="h-3.5 w-3.5" data-lucide="bar-chart-3"></i>
                    Financial Dashboard
                </span>
                <div class="space-y-2">
                    <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl">Real-Time Financial Analytics</h1>
                    <p class="text-base text-muted-foreground sm:text-lg">Live charts and visualizations powered by your Xero data.</p>
                </div>
                <div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                    <span class="inline-flex items-center gap-2 rounded-full border border-border/70 bg-muted/60 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground" id="data-status">
                        <i class="h-4 w-4" data-lucide="database"></i>
                        <span id="data-source">Loading...</span>
                    </span>
                    <span class="inline-flex items-center gap-2 text-sm font-medium text-emerald-600"><i class="h-4 w-4" data-lucide="refresh-cw"></i>Live Data</span>
                </div>
            </div>
            <div class="flex flex-col gap-3 sm:flex-row">
                <a href="/api/export/excel" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-5 py-2.5 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                    <i class="h-4 w-4" data-lucide="download"></i>
                    Export to Excel
                </a>
                <button onclick="refreshDashboard()" class="inline-flex items-center justify-center gap-2 rounded-lg border border-border/70 bg-card px-5 py-2.5 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80">
                    <i class="h-4 w-4" data-lucide="refresh-cw"></i>
                    Refresh Data
                </button>
            </div>
        </div>
    </div>

    <!-- Xero Connection Required -->
    {% if not xero_connected %}
    <div class="card border border-primary/50 bg-primary/5 p-8">
        <div class="text-center space-y-6">
            <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-primary/10 text-primary">
                <i class="h-8 w-8" data-lucide="link"></i>
            </div>
            <div class="space-y-3">
                <h3 class="text-xl font-semibold text-foreground">Connect to Xero</h3>
                <p class="text-sm text-muted-foreground max-w-md mx-auto">
                    To view your financial dashboard with real-time data, you need to connect your Xero account first.
                    All charts and analytics will be powered by your live Xero data.
                </p>
            </div>
            <div class="flex flex-col gap-3 sm:flex-row sm:justify-center">
                <a href="/setup" class="inline-flex items-center justify-center gap-2 rounded-lg bg-primary px-6 py-3 text-sm font-medium text-primary-foreground shadow-sm transition hover:bg-primary/90">
                    <i class="h-4 w-4" data-lucide="settings"></i>
                    Go to Setup Wizard
                </a>
                <a href="/health" class="inline-flex items-center justify-center gap-2 rounded-lg border border-border/70 bg-card px-6 py-3 text-sm font-medium text-foreground transition hover:border-border hover:bg-card/80">
                    <i class="h-4 w-4" data-lucide="activity"></i>
                    Check System Status
                </a>
            </div>
            <div class="text-xs text-muted-foreground">
                <i class="h-4 w-4 inline mr-1" data-lucide="shield"></i>
                Your credentials are encrypted and stored securely on your device
            </div>
        </div>
    </div>
    {% else %}

    <!-- Error State -->
    <div id="error-state" class="card border border-destructive/50 bg-destructive/5 p-6 hidden">
        <div class="flex items-center gap-3">
            <i class="h-5 w-5 text-destructive" data-lucide="alert-circle"></i>
            <div>
                <h3 class="font-semibold text-destructive">Failed to Load Xero Data</h3>
                <p class="text-sm text-muted-foreground mt-1" id="error-message">Unable to fetch real-time financial data.</p>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <div class="card p-6">
            <div class="animate-pulse">
                <div class="h-4 bg-muted rounded w-3/4 mb-4"></div>
                <div class="h-64 bg-muted rounded"></div>
            </div>
        </div>
        <div class="card p-6">
            <div class="animate-pulse">
                <div class="h-4 bg-muted rounded w-3/4 mb-4"></div>
                <div class="h-64 bg-muted rounded"></div>
            </div>
        </div>
        <div class="card p-6">
            <div class="animate-pulse">
                <div class="h-4 bg-muted rounded w-3/4 mb-4"></div>
                <div class="h-64 bg-muted rounded"></div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div id="charts-container" class="hidden grid gap-6">
        <!-- Revenue by Customer -->
        <div class="card p-6 lg:col-span-2">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Revenue by Customer</h3>
                <span class="text-sm text-muted-foreground">From Xero Invoices</span>
            </div>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="revenue-by-customer-chart"></canvas>
            </div>
        </div>

        <!-- Invoice Status Distribution -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Invoice Status</h3>
                <span class="text-sm text-muted-foreground">Current State</span>
            </div>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="invoice-status-chart"></canvas>
            </div>
        </div>

        <!-- Monthly Revenue Trend -->
        <div class="card p-6 lg:col-span-3">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Monthly Revenue Trend</h3>
                <span class="text-sm text-muted-foreground">Invoice Date Analysis</span>
            </div>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="monthly-revenue-chart"></canvas>
            </div>
        </div>

        <!-- Payment Status -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Payment Status</h3>
                <span class="text-sm text-muted-foreground">Outstanding vs Paid</span>
            </div>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="payment-status-chart"></canvas>
            </div>
        </div>

        <!-- Account Types -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Account Types</h3>
                <span class="text-sm text-muted-foreground">Chart of Accounts</span>
            </div>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="account-types-chart"></canvas>
            </div>
        </div>

        <!-- Contact Types -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold">Contacts Breakdown</h3>
                <span class="text-sm text-muted-foreground">Customers vs Suppliers</span>
            </div>
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="contact-types-chart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Chart colors consistent with shadcn/ui theme
const COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'];

let chartInstances = {};

function createChart(canvasId, type, data, options) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }

    chartInstances[canvasId] = new Chart(ctx, {
        type: type,
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2,
            ...options
        }
    });

    return chartInstances[canvasId];
}

function fetchDashboardData() {
    fetch('/api/dashboard/charts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderCharts(data.chart_data);
                document.getElementById('data-source').textContent = 'Xero Connected';
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('charts-container').classList.remove('hidden');
                document.getElementById('error-state').classList.add('hidden');
            } else {
                throw new Error(data.error || 'Failed to load data');
            }
        })
        .catch(error => {
            console.error('Error fetching dashboard data:', error);
            document.getElementById('data-source').textContent = 'Connection Error';
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('charts-container').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('error-message').textContent = error.message;
        });
}

function renderCharts(chartData) {
    // Revenue by Customer Bar Chart
    if (chartData.revenue_by_customer) {
        createChart('revenue-by-customer-chart', 'bar', {
            labels: chartData.revenue_by_customer.map(item => item.name),
            datasets: [{
                label: 'Revenue',
                data: chartData.revenue_by_customer.map(item => item.value),
                backgroundColor: '#3B82F6',
                borderColor: '#2563EB',
                borderWidth: 1
            }]
        }, {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        });
    }

    // Invoice Status Pie Chart
    if (chartData.invoice_status) {
        createChart('invoice-status-chart', 'doughnut', {
            labels: chartData.invoice_status.map(item => item.name),
            datasets: [{
                data: chartData.invoice_status.map(item => item.value),
                backgroundColor: COLORS.slice(0, chartData.invoice_status.length)
            }]
        });
    }

    // Monthly Revenue Line Chart
    if (chartData.monthly_revenue) {
        createChart('monthly-revenue-chart', 'line', {
            labels: chartData.monthly_revenue.map(item => item.month),
            datasets: [{
                label: 'Revenue',
                data: chartData.monthly_revenue.map(item => item.revenue),
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        }, {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        });
    }

    // Payment Status Pie Chart
    if (chartData.payment_status) {
        createChart('payment-status-chart', 'doughnut', {
            labels: chartData.payment_status.map(item => item.name),
            datasets: [{
                data: chartData.payment_status.map(item => item.value),
                backgroundColor: ['#EF4444', '#10B981']
            }]
        });
    }

    // Account Types Bar Chart
    if (chartData.account_types) {
        createChart('account-types-chart', 'bar', {
            labels: chartData.account_types.map(item => item.name.replace('AccountType.', '')),
            datasets: [{
                label: 'Number of Accounts',
                data: chartData.account_types.map(item => item.value),
                backgroundColor: '#8B5CF6',
                borderColor: '#7C3AED',
                borderWidth: 1
            }]
        }, {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        });
    }

    // Contact Types Pie Chart
    if (chartData.contact_types) {
        createChart('contact-types-chart', 'doughnut', {
            labels: chartData.contact_types.map(item => item.name),
            datasets: [{
                data: chartData.contact_types.map(item => item.value),
                backgroundColor: ['#3B82F6', '#F59E0B']
            }]
        });
    }
}

// Make refresh function available globally
window.refreshDashboard = fetchDashboardData;

// Load data when page is ready
document.addEventListener('DOMContentLoaded', function() {
    {% if xero_connected %}
    fetchDashboardData();
    {% endif %}
});
</script>
{% endblock %}